//! –¢–µ—Å—Ç—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ XAuth

use std::time::Duration;
use tokio::time::timeout;
use xnetwork2::Node;

mod utils;
use utils::{setup_listening_node, dial_and_wait_connection, spawn_auth_completion_task, spawn_auto_respond_por_task, spawn_connection_id_listener_task};

/// –¢–µ—Å—Ç —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
/// –í–µ—Å—å —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —É–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ 15 —Å–µ–∫—É–Ω–¥
/// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
#[tokio::test]
async fn test_xauth_manual_mode() {
    println!("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ XAuth (15 —Å–µ–∫—É–Ω–¥)...");

    // –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤–µ—Å—å —Ç–µ—Å—Ç - 15 —Å–µ–∫—É–Ω–¥
    let result = timeout(Duration::from_secs(15), async {
        // 1. –°–û–ó–î–ê–ù–ò–ï –î–í–£–• –ù–û–î (0-1 —Å–µ–∫—É–Ω–¥–∞)
        println!("üÜï –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–¥—ã...");
        let mut node1 = Node::new().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É 1 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        let mut node2 = Node::new().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É 2 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

        println!("‚úÖ –ù–æ–¥—ã —Å–æ–∑–¥–∞–Ω—ã:");
        println!("   Node1 PeerId: {}", node1.peer_id());
        println!("   Node2 PeerId: {}", node2.peer_id());

        // 2. –ó–ê–ü–£–°–ö –û–ë–ï–ò–• –ù–û–î (1-2 —Å–µ–∫—É–Ω–¥—ã)
        println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–µ –Ω–æ–¥—ã...");
        node1.start().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É 1 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        node2.start().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É 2 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

        println!("‚úÖ –û–±–µ –Ω–æ–¥—ã –∑–∞–ø—É—â–µ–Ω—ã");

        // 3. –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–Ø (2-4 —Å–µ–∫—É–Ω–¥—ã)
        println!("üéØ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ...");
        let node1_addr = setup_listening_node(&mut node1).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–æ–¥—ã 1");
        let node2_addr = setup_listening_node(&mut node2).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–æ–¥—ã 2");

        println!("‚úÖ –ù–æ–¥—ã —Å–ª—É—à–∞—é—Ç:");
        println!("   Node1 –∞–¥—Ä–µ—Å: {}", node1_addr);
        println!("   Node2 –∞–¥—Ä–µ—Å: {}", node2_addr);

        // 4. –†–ï–ñ–ò–ú –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ - –†–£–ß–ù–û–ô (4-5 —Å–µ–∫—É–Ω–¥)
        println!("üîÑ –†–µ–∂–∏–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ä—É—á–Ω–æ–π...");
        println!("‚úÖ –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±–µ–∏—Ö –Ω–æ–¥");

        // 5. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ò –ü–†–û–í–ï–†–ö–ê –û–¢–°–£–¢–°–¢–í–ò–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (5-8 —Å–µ–∫—É–Ω–¥)
        println!("üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–æ–¥—É 1 –∫ –Ω–æ–¥–µ 2...");
        
        // 5.1. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –æ–∂–∏–¥–∞–Ω–∏—è connection_id –¥–ª—è –Ω–æ–¥—ã 2 –î–û dial_and_wait_connection
        let connection_id_listener_task = spawn_connection_id_listener_task(
            &mut node2, 
            *node1.peer_id(), 
            Duration::from_secs(3)
        );

        // 5.2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ–º connection_id –¥–ª—è –Ω–æ–¥—ã 1
        let connection_id1: libp2p::swarm::ConnectionId = dial_and_wait_connection(
            &mut node1, 
            *node2.peer_id(), 
            node2_addr.clone(), 
            Duration::from_secs(3)
        ).await.expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ");

        // 5.3. –ü–æ–ª—É—á–∞–µ–º connection_id –¥–ª—è –Ω–æ–¥—ã 2 –∏–∑ –∑–∞–¥–∞—á–∏-—Å–ª—É—à–∞—Ç–µ–ª—è
        let connection_id2 = connection_id_listener_task.await
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –æ–∂–∏–¥–∞–Ω–∏—è connection_id –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (join)")
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –æ–∂–∏–¥–∞–Ω–∏—è connection_id –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (task)");

        println!("‚úÖ Connection_id –ø–æ–ª—É—á–µ–Ω—ã: node1={:?}, node2={:?}", connection_id1, connection_id2);

        // 5.3. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        let auth_completion_task1 = spawn_auth_completion_task(&mut node1, *node2.peer_id(), Duration::from_secs(5));
        let auth_completion_task2 = spawn_auth_completion_task(&mut node2, *node1.peer_id(), Duration::from_secs(5));

        // 5.4. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ PoR –∑–∞–ø—Ä–æ—Å—ã
        let auto_respond_task1 = spawn_auto_respond_por_task(&mut node1, *node2.peer_id(), Duration::from_secs(5));
        let auto_respond_task2 = spawn_auto_respond_por_task(&mut node2, *node1.peer_id(), Duration::from_secs(5));

        // 5.5. –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –Ω–∞ –æ–±–µ–∏—Ö –Ω–æ–¥–∞—Ö
        println!("üîê –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –Ω–∞ –æ–±–µ–∏—Ö –Ω–æ–¥–∞—Ö...");
        node1.commander.start_auth_for_connection(connection_id1).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ –Ω–æ–¥–µ 1");
        node2.commander.start_auth_for_connection(connection_id2).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ –Ω–æ–¥–µ 2");

        // 5.6. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
        println!("‚è≥ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...");
        auth_completion_task1.await
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–¥—ã 1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (join)")
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–¥—ã 1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (task)");
        auth_completion_task2.await
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (join)")
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (task)");
        auto_respond_task1.await
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–¥—ã 1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (join)")
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–¥—ã 1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (task)");
        auto_respond_task2.await
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (join)")
            .expect("‚ùå –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–¥—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (task)");

        println!("‚úÖ –†—É—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");

        // 7. –ü–†–û–í–ï–†–ö–ê –§–ò–ù–ê–õ–¨–ù–û–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø (13-14 —Å–µ–∫—É–Ω–¥)
        println!(" –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏...");
        let final_state = node1.commander.get_network_state().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ");
        
        assert!(!final_state.connected_peers.is_empty(), 
            "‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∏—Ä–æ–≤ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–¥–∞2 –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∏—Ä–æ–≤
        let node2_in_peers = final_state.connected_peers.iter()
            .any(|peer| peer == node2.peer_id());
        
        assert!(node2_in_peers, "‚ùå –ù–æ–¥–∞2 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∏—Ä–æ–≤");

        println!("‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:");
        println!("   –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∏—Ä—ã: {}", final_state.connected_peers.len());
        println!("   –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–µ–Ω–∞: {}", node2_in_peers);

        // 8. GRACEFUL SHUTDOWN –û–ë–ï–ò–• –ù–û–î (14-15 —Å–µ–∫—É–Ω–¥)
        println!("üõë –í—ã–ø–æ–ª–Ω—è–µ–º graceful shutdown –æ–±–µ–∏—Ö –Ω–æ–¥...");
        node1.commander.shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å graceful shutdown –Ω–æ–¥—ã 1");
        node2.commander.shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å graceful shutdown –Ω–æ–¥—ã 2");

        println!("‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á...");
        node1.wait_for_shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã 1");
        node2.wait_for_shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã 2");

        println!("‚úÖ –û–±–µ –Ω–æ–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–∞–±–æ—Ç—É");

        // 9. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
        assert_eq!(node1.get_task_status(), "not_started",
            "‚ùå –ù–æ–¥–∞1 –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'not_started' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        assert_eq!(node2.get_task_status(), "not_started",
            "‚ùå –ù–æ–¥–∞2 –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'not_started' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        assert!(!node1.is_running(), "‚ùå –ù–æ–¥–∞1 –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ graceful shutdown");
        assert!(!node2.is_running(), "‚ùå –ù–æ–¥–∞2 –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ graceful shutdown");

        println!("üéâ –¢–µ—Å—Ç —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    }).await;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ—Å—Ç —É–ª–æ–∂–∏–ª—Å—è –≤ 15 —Å–µ–∫—É–Ω–¥
    match result {
        Ok(_) => println!("‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ {} —Å–µ–∫—É–Ω–¥ - –í–°–ï–ì–û 15 –°–ï–ö–£–ù–î!", 15),
        Err(_) => panic!("‚ùå –¢–ï–°–¢ –ü–†–ï–í–´–°–ò–õ –õ–ò–ú–ò–¢ –í 15 –°–ï–ö–£–ù–î - –ü–†–û–ë–õ–ï–ú–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò!"),
    }
}

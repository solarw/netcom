//! –¢–µ—Å—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã get_external_addresses

use libp2p::Multiaddr;
use xnetwork2::NodeBuilder;

/// –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ commander
#[tokio::test]
async fn test_get_external_addresses() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç get_external_addresses...");

    // –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª
    println!("üÜï –°–æ–∑–¥–∞–µ–º node...");
    let mut node = NodeBuilder::new()
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å node —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    // –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª...");
    node.start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å node —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    println!("‚úÖ –£–∑–µ–ª —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω: {:?}", node.peer_id());

    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)
    println!("üåê –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π)...");
    let initial_external_addrs = node.commander.get_external_addresses()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞");

    println!("üìä –ù–∞—á–∞–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞: {:?}", initial_external_addrs);
    assert!(initial_external_addrs.is_empty(), "‚ùå –ù–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º");

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å
    println!("‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å...");
    let test_addr: Multiaddr = "/ip4/1.2.3.4/tcp/1234".parse()
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å");

    node.commander.add_external_address(test_addr.clone())
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å");

    println!("‚úÖ –í–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω: {}", test_addr);

    // –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ —Å–Ω–æ–≤–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å)
    println!("üåê –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è...");
    let external_addrs = node.commander.get_external_addresses()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞");

    println!("üìä –í–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {:?}", external_addrs);
    assert!(!external_addrs.is_empty(), "‚ùå –°–ø–∏—Å–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
    assert!(external_addrs.contains(&test_addr), "‚ùå –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤");

    // –î–æ–±–∞–≤–ª—è–µ–º –µ—â–µ –æ–¥–∏–Ω –∞–¥—Ä–µ—Å
    println!("‚ûï –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å...");
    let test_addr2: Multiaddr = "/ip4/5.6.7.8/tcp/5678".parse()
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å");

    node.commander.add_external_address(test_addr2.clone())
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å");

    println!("‚úÖ –í—Ç–æ—Ä–æ–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω: {}", test_addr2);

    // –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ —Å–Ω–æ–≤–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±–∞ –∞–¥—Ä–µ—Å–∞)
    println!("üåê –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ –∞–¥—Ä–µ—Å–∞...");
    let external_addrs_final = node.commander.get_external_addresses()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞");

    println!("üìä –§–∏–Ω–∞–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞: {:?}", external_addrs_final);
    assert_eq!(external_addrs_final.len(), 2, "‚ùå –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–∞");
    assert!(external_addrs_final.contains(&test_addr), "‚ùå –ü–µ—Ä–≤—ã–π –∞–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ");
    assert!(external_addrs_final.contains(&test_addr2), "‚ùå –í—Ç–æ—Ä–æ–π –∞–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ");

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    println!("üßπ –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...");
    node.force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å node —É–∑–µ–ª");

    println!("üéâ –¢–µ—Å—Ç get_external_addresses —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    Ok(())
}

/// –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ–º
#[tokio::test]
async fn test_get_external_addresses_with_listening() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç get_external_addresses —Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ–º...");

    // –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª
    let mut node = NodeBuilder::new()
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å node —É–∑–µ–ª");

    // –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª
    node.start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å node —É–∑–µ–ª");

    println!("‚úÖ –£–∑–µ–ª —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω: {:?}", node.peer_id());

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
    println!("üéØ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ...");
    let listen_addr = node.commander.listen_and_wait(
        "/ip4/127.0.0.1/tcp/0/udp/0/quic-v1".parse().unwrap(),
        std::time::Duration::from_secs(5)
    ).await
    .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ");

    println!("üì° –£–∑–µ–ª —Å–ª—É—à–∞–µ—Ç –Ω–∞: {}", listen_addr);

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∫–∞–∫ –≤–Ω–µ—à–Ω–∏–π
    println!("üåê –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∫–∞–∫ –≤–Ω–µ—à–Ω–∏–π...");
    node.commander.add_external_address(listen_addr.clone())
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å");

    println!("‚úÖ –ê–¥—Ä–µ—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –≤–Ω–µ—à–Ω–∏–π: {}", listen_addr);

    // –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
    println!("üåê –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...");
    let external_addrs = node.commander.get_external_addresses()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞");

    println!("üìä –í–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞: {:?}", external_addrs);
    assert!(!external_addrs.is_empty(), "‚ùå –°–ø–∏—Å–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    assert!(external_addrs.contains(&listen_addr), "‚ùå –ê–¥—Ä–µ—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤");

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    println!("üßπ –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...");
    node.force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å node —É–∑–µ–ª");

    println!("üéâ –¢–µ—Å—Ç get_external_addresses —Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ–º —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    Ok(())
}

//! –¢–µ—Å—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö XStream

use std::time::Duration;
use tokio::time::timeout;
use xnetwork2::node_events::NodeEvent;
use xnetwork2::{InboundDecisionPolicy, Node};

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö XStream
#[tokio::test]
async fn test_xstream_decision_error_propagation() {
    println!("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥–∞—á—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö XStream...");

    // –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–¥—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
    let mut node1 = Node::builder()
        .await
        .with_inbound_decision_policy(InboundDecisionPolicy::AutoApprove)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É1");

    let mut node2 = Node::builder()
        .await
        .with_inbound_decision_policy(InboundDecisionPolicy::ManualApprove)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É2");

    println!("‚úÖ –°–æ–∑–¥–∞–Ω—ã –¥–≤–µ –Ω–æ–¥—ã:");
    println!("   - –ù–æ–¥–∞1: AutoApprove (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä—è–µ—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –ø–æ—Ç–æ–∫–∏)");
    println!("   - –ù–æ–¥–∞2: ManualApprove (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è)");

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–µ –Ω–æ–¥—ã
    node1.start().await.expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É1");
    node2.start().await.expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É2");

    // –ù–æ–¥–∞1 —Å–ª—É—à–∞–µ—Ç –Ω–∞ localhost —Å QUIC
    node1
        .commander
        .listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap())
        .await
        .expect("‚ùå –ù–æ–¥–∞1 –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å");

    // –ù–æ–¥–∞2 —Å–ª—É—à–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É —Å QUIC
    node2
        .commander
        .listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap())
        .await
        .expect("‚ùå –ù–æ–¥–∞2 –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å");

    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –Ω–æ–¥—ã1
    let node1_addr = node1
        .commander
        .get_network_state()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ –Ω–æ–¥—ã1")
        .listening_addresses
        .first()
        .expect("‚ùå –ù–æ–¥–∞1 –Ω–µ –∏–º–µ–µ—Ç –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è")
        .clone();

    println!("üì° –ù–æ–¥–∞1 —Å–ª—É—à–∞–µ—Ç –Ω–∞: {}", node1_addr);

    // –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–æ–¥–µ1
    node2
        .commander
        .dial(node1.peer_id().clone(), node1_addr.clone())
        .await
        .expect("‚ùå –ù–æ–¥–∞2 –Ω–µ —Å–º–æ–≥–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–æ–¥–µ1");

    println!("‚úÖ –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–∏–ª–∞—Å—å –∫ –Ω–æ–¥–µ1");

    // –ñ–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    tokio::time::sleep(Duration::from_millis(500)).await;

    // –ù–æ–¥–∞1 –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å XStream –∫ –Ω–æ–¥–µ2 (–æ–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ –Ω–æ–¥–∞2 —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è)
    println!("üîÑ –ù–æ–¥–∞1 –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å XStream –∫ –Ω–æ–¥–µ2 (–æ–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É)...");

    let xstream_result = node1.commander.open_xstream(node2.peer_id().clone()).await;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –æ—à–∏–±–∫—É
    assert!(
        xstream_result.is_err(),
        "‚ùå –û–∂–∏–¥–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ XStream, –Ω–æ –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ"
    );

    let error = xstream_result.unwrap_err();
    println!("‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞: {}", error);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—à–∏–±–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
    let error_string = error.to_string();
    assert!(
        error_string.contains("ConnectionRefused")
            || error_string.contains("rejected")
            || error_string.contains("–æ—Ç–∫–ª–æ–Ω–µ–Ω")
            || error_string.contains("unauthorized")
            || error_string.contains("auth"),
        "‚ùå –û—à–∏–±–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: {}",
        error_string
    );

    println!("‚úÖ –û—à–∏–±–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ –æ—Ç –Ω–æ–¥—ã2 –∫ –Ω–æ–¥–µ1 —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª XStream");

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–¥—ã
    node1
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É1");
    node2
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É2");

    println!("üéâ –¢–µ—Å—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö XStream –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
}

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ XStream –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è
#[tokio::test]
async fn test_xstream_decision_approval_success() {
    println!("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ XStream –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è...");

    // –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–¥—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
    let mut node1 = Node::builder()
        .await
        .with_inbound_decision_policy(InboundDecisionPolicy::AutoApprove)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É1");

    let mut node2 = Node::builder()
        .await
        .with_inbound_decision_policy(InboundDecisionPolicy::ManualApprove)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É2");

    println!("‚úÖ –°–æ–∑–¥–∞–Ω—ã –¥–≤–µ –Ω–æ–¥—ã:");
    println!("   - –ù–æ–¥–∞1: AutoApprove (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä—è–µ—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –ø–æ—Ç–æ–∫–∏)");
    println!("   - –ù–æ–¥–∞2: ManualApprove (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è)");

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–µ –Ω–æ–¥—ã
    node1.start().await.expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É1");
    node2.start().await.expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É2");

    // –ù–æ–¥–∞1 —Å–ª—É—à–∞–µ—Ç –Ω–∞ localhost —Å QUIC
    node1
        .commander
        .listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap())
        .await
        .expect("‚ùå –ù–æ–¥–∞1 –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å");

    // –ù–æ–¥–∞2 —Å–ª—É—à–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É —Å QUIC
    node2
        .commander
        .listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap())
        .await
        .expect("‚ùå –ù–æ–¥–∞2 –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å");

    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –Ω–æ–¥—ã1
    let node1_addr = node1
        .commander
        .get_network_state()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ –Ω–æ–¥—ã1")
        .listening_addresses
        .first()
        .expect("‚ùå –ù–æ–¥–∞1 –Ω–µ –∏–º–µ–µ—Ç –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è")
        .clone();

    println!("üì° –ù–æ–¥–∞1 —Å–ª—É—à–∞–µ—Ç –Ω–∞: {}", node1_addr);

    // –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–æ–¥–µ1
    node2
        .commander
        .dial(node1.peer_id().clone(), node1_addr.clone())
        .await
        .expect("‚ùå –ù–æ–¥–∞2 –Ω–µ —Å–º–æ–≥–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–æ–¥–µ1");

    println!("‚úÖ –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–∏–ª–∞—Å—å –∫ –Ω–æ–¥–µ1");

    // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ–±–µ–∏—Ö –Ω–æ–¥–∞—Ö
    let node1_commander = node1.commander.clone();
    let node1_events = node1.subscribe();
    let node2_commander = node2.commander.clone();
    let node2_events = node2.subscribe();

    // –ó–∞–¥–∞—á–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–¥–µ1
    let auth_task1 = tokio::spawn(async move {
        println!("üîÑ –ù–æ–¥–∞1 –æ–∂–∏–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...");

        let mut event_receiver = node1_events;

        loop {
            match timeout(Duration::from_secs(10), event_receiver.recv()).await {
                Ok(Ok(event)) => {
                    if let NodeEvent::VerifyPorRequest {
                        peer_id,
                        
                        ..
                    } = event
                    {
                        println!("‚úÖ –ù–æ–¥–∞1 –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ç –Ω–æ–¥—ã2");

                        // –û–¥–æ–±—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                        let auth_result =
                            node1_commander.submit_por_verification(peer_id, true).await;
                        assert!(
                            auth_result.is_ok(),
                            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ –Ω–æ–¥–µ1"
                        );
                        println!("‚úÖ –ù–æ–¥–∞1 –æ–¥–æ–±—Ä–∏–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–æ–¥—ã2");
                        break;
                    }
                }
                Ok(Err(_)) => {
                    panic!("‚ùå –ö–∞–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –Ω–æ–¥—ã1 –∑–∞–∫—Ä—ã—Ç");
                }
                Err(_) => {
                    panic!("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–¥–µ1");
                }
            }
        }
    });

    // –ó–∞–¥–∞—á–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –Ω–æ–¥–µ2
    let approval_task = tokio::spawn(async move {
        println!("üîÑ –ù–æ–¥–∞2 –æ–∂–∏–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ XStream...");

        let mut event_receiver = node2_events;

        // –°–Ω–∞—á–∞–ª–∞ –∂–¥–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        loop {
            match timeout(Duration::from_secs(10), event_receiver.recv()).await {
                Ok(Ok(event)) => {
                    if let NodeEvent::VerifyPorRequest {
                        peer_id,
                        
                        ..
                    } = event
                    {
                        println!("‚úÖ –ù–æ–¥–∞2 –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ç –Ω–æ–¥—ã1");

                        // –û–¥–æ–±—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                        let auth_result =
                            node2_commander.submit_por_verification(peer_id, true).await;
                        assert!(
                            auth_result.is_ok(),
                            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ –Ω–æ–¥–µ2"
                        );
                        println!("‚úÖ –ù–æ–¥–∞2 –æ–¥–æ–±—Ä–∏–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–æ–¥—ã1");
                        break;
                    }
                }
                Ok(Err(_)) => {
                    panic!("‚ùå –ö–∞–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –Ω–æ–¥—ã2 –∑–∞–∫—Ä—ã—Ç");
                }
                Err(_) => {
                    panic!("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–¥–µ2");
                }
            }
        }

        // –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ XStream
        println!("üîÑ –ù–æ–¥–∞2 –æ–∂–∏–¥–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ XStream...");

        loop {
            match timeout(Duration::from_secs(10), event_receiver.recv()).await {
                Ok(Ok(event)) => {
                    if let NodeEvent::XStreamIncomingStreamRequest {
                        peer_id: _,
                        connection_id: _,
                        decision_sender,
                    } = event
                    {
                        println!("‚úÖ –ù–æ–¥–∞2 –ø–æ–ª—É—á–∏–ª–∞ –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ XStream –æ—Ç –Ω–æ–¥—ã1");

                        // –û–¥–æ–±—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å
                        let approve_result = decision_sender.approve();
                        assert!(
                            approve_result.is_ok(),
                            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–π XStream"
                        );
                        println!("‚úÖ –ù–æ–¥–∞2 –æ–¥–æ–±—Ä–∏–ª–∞ –≤—Ö–æ–¥—è—â–∏–π XStream –æ—Ç –Ω–æ–¥—ã1");
                    }
                }
                Ok(Err(_)) => {
                    panic!("‚ùå –ö–∞–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –Ω–æ–¥—ã2 –∑–∞–∫—Ä—ã—Ç");
                }
                Err(_) => {
                    panic!("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–æ–¥–µ2");
                }
            }
        }
    });

    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ–±–µ–∏—Ö –Ω–æ–¥–∞—Ö
    auth_task1
        .await
        .expect("‚ùå –ó–∞–¥–∞—á–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–æ–¥—ã1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π");
    println!("‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –Ω–æ–¥–µ1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞");

    // –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    tokio::time::sleep(Duration::from_millis(500)).await;

    // –ù–æ–¥–∞1 –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å XStream –∫ –Ω–æ–¥–µ2 (–æ–∂–∏–¥–∞–µ–º —É—Å–ø–µ—Ö –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è)
    println!("üîÑ –ù–æ–¥–∞1 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç XStream –∫ –Ω–æ–¥–µ2 (–æ–∂–∏–¥–∞–µ–º —É—Å–ø–µ—Ö –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è)...");

    let xstream_result = timeout(
        Duration::from_secs(10),
        node1.commander.open_xstream(node2.peer_id().clone()),
    )
    .await;

    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è
    approval_task.abort();
    let _ = approval_task.await;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ XStream —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç
    assert!(xstream_result.is_ok(), "‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ XStream");
    let xstream = xstream_result
        .unwrap()
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å XStream –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è");

    println!("‚úÖ XStream —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –Ω–æ–¥—ã2");

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ XStream —Ä–∞–±–æ—Ç–∞–µ—Ç
    assert_eq!(
        xstream.peer_id,
        *node2.peer_id(),
        "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π peer_id –≤ XStream"
    );

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º XStream
    drop(xstream);

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–¥—ã
    node1
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É1");
    node2
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É2");

    println!("üéâ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è XStream –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
}

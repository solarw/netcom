//! –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç –¥–≤—É—Ö –Ω–æ–¥ —Å XStream: —Ä–µ–∞–ª—å–Ω—ã–π –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

use std::time::Duration;
use tokio::time::{timeout, sleep};
use xnetwork2::Node;
use xnetwork2::node_events::NodeEvent;
use xstream::xstream::XStream;

/// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
async fn wait_for_event<F>(
    events: &mut tokio::sync::broadcast::Receiver<NodeEvent>,
    predicate: F,
    timeout_duration: Duration,
) -> Result<NodeEvent, Box<dyn std::error::Error + Send + Sync>>
where
    F: Fn(&NodeEvent) -> bool,
{
    timeout(timeout_duration, async {
        loop {
            match events.recv().await {
                Ok(event) => {
                    if predicate(&event) {
                        return Ok(event);
                    }
                }
                Err(e) => {
                    return Err(format!("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: {}", e).into());
                }
            }
        }
    }).await?
}

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ XStream –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–æ–¥–∞–º–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
/// –í–µ—Å—å —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —É–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ 5 —Å–µ–∫—É–Ω–¥
#[tokio::test]
async fn test_two_nodes_xstream_complete_data_transfer_in_5_seconds() {
    println!("üß™ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ XStream —Å —Ä–µ–∞–ª—å–Ω—ã–º –æ–±–º–µ–Ω–æ–º –¥–∞–Ω–Ω—ã—Ö (5 —Å–µ–∫—É–Ω–¥)...");
    
    // –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤–µ—Å—å —Ç–µ—Å—Ç - 5 —Å–µ–∫—É–Ω–¥
    let result = timeout(Duration::from_secs(5), async {
        // 1. –°–û–ó–î–ê–ù–ò–ï –î–í–£–• –ù–û–î
        println!("üÜï –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–¥—ã...");
        let mut node1 = Node::new().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        let mut node2 = Node::new().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä—É—é –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ù–æ–¥—ã —Å–æ–∑–¥–∞–Ω—ã:");
        println!("   Node1 PeerId: {}", node1.peer_id());
        println!("   Node2 PeerId: {}", node2.peer_id());
        
        // 2. –ü–û–î–ü–ò–°–ö–ê –ù–ê –°–û–ë–´–¢–ò–Ø –î–û –ó–ê–ü–£–°–ö–ê
        println!("üì° –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ–±–µ–∏—Ö –Ω–æ–¥...");
        let mut node1_events = node1.subscribe();
        let mut node2_events = node2.subscribe();
        
        // –°–æ–∑–¥–∞–µ–º oneshot –∫–∞–Ω–∞–ª –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
        let (data_sender, data_receiver) = tokio::sync::oneshot::channel();
        
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π receiver –¥–ª—è –∑–∞–¥–∞—á–∏ –Ω–æ–¥—ã1
        let mut node1_events_task = node1.subscribe();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö XStream –Ω–∞ –Ω–æ–¥–µ1
        let node1_task = tokio::spawn(async move {
            println!("üéØ –ù–æ–¥–∞1 –æ–∂–∏–¥–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–π XStream...");
            
            while let Ok(event) = node1_events_task.recv().await {
                match event {
                    NodeEvent::XStreamIncoming { mut stream } => {
                        println!("‚úÖ –ù–æ–¥–∞1 –ø–æ–ª—É—á–∏–ª–∞ –≤—Ö–æ–¥—è—â–∏–π XStream:");
                        println!("   Stream ID: {:?}", stream.id);
                        println!("   Peer ID: {}", stream.peer_id);
                        
                        // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ XStream
                        println!("üì• –ù–æ–¥–∞1 —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ XStream...");
                        match stream.read_to_end().await {
                            Ok(data) => {
                                println!("‚úÖ –ù–æ–¥–∞1 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ:");
                                println!("   –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {} –±–∞–π—Ç", data.len());
                                println!("   –î–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(&data));
                                
                                // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ - –¥–æ–±–∞–≤–ª—è–µ–º "Real Response" –ø–æ —á–∞—Å—Ç—è–º
                                let original_data = String::from_utf8_lossy(&data);
                                let part1 = format!("{} Real", original_data);
                                let part2 = " Response".to_string();
                                
                                println!("üîÑ –ù–æ–¥–∞1 –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å—Ç—è–º:");
                                println!("   –ß–∞—Å—Ç—å 1: {}", part1);
                                println!("   –ß–∞—Å—Ç—å 2: {}", part2);
                                
                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å—Ç—è–º
                                println!("üì§ –ù–æ–¥–∞1 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å—Ç—è–º...");
                                
                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å
                                match stream.write_all(part1.as_bytes().to_vec()).await {
                                    Ok(_) => {
                                        println!("‚úÖ –ù–æ–¥–∞1 —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö");
                                    }
                                    Err(e) => {
                                        panic!("‚ùå –ù–æ–¥–∞1 –Ω–µ —Å–º–æ–≥–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: {:?}", e);
                                    }
                                }

                                // delay to check that .read_to_end() only works not .read()
                                sleep(Duration::from_millis(100)).await;

                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å
                                match stream.write_all(part2.as_bytes().to_vec()).await {
                                    Ok(_) => {
                                        println!("‚úÖ –ù–æ–¥–∞1 —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö");
                                    }
                                    Err(e) => {
                                        panic!("‚ùå –ù–æ–¥–∞1 –Ω–µ —Å–º–æ–≥–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: {:?}", e);
                                    }
                                }
                                stream.write_eof().await;
                                
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º XStream –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                                println!("üõë –ù–æ–¥–∞1 –∑–∞–∫—Ä—ã–≤–∞–µ—Ç XStream...");
                                match stream.close().await {
                                    Ok(_) => println!("‚úÖ –ù–æ–¥–∞1 —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã–ª–∞ XStream"),
                                    Err(e) => println!("‚ö†Ô∏è  –ù–æ–¥–∞1: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ XStream: {:?}", e),
                                }
                                
                                // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ oneshot –∫–∞–Ω–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                                let _ = data_sender.send(data);
                            }
                            Err(e) => {
                                panic!("‚ùå –ù–æ–¥–∞1 –Ω–µ —Å–º–æ–≥–ª–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ XStream: {:?}", e);
                            }
                        }
                        break;
                    }
                    _ => continue, // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è
                }
            }
        });
        
        // 3. –ó–ê–ü–£–°–ö –û–ë–ï–ò–• –ù–û–î
        println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–µ –Ω–æ–¥—ã...");
        node1.start().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—É—é –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        node2.start().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ç–æ—Ä—É—é –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –û–±–µ –Ω–æ–¥—ã –∑–∞–ø—É—â–µ–Ω—ã:");
        println!("   Node1 —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {}", node1.get_task_status());
        println!("   Node2 —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {}", node2.get_task_status());
        
        // 4. –ù–û–î–ê1 –ù–ê–ß–ò–ù–ê–ï–¢ –°–õ–£–®–ê–¢–¨
        println!("üéØ –ù–æ–¥–∞1 –Ω–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ...");
        node1.commander.listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap()).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å listen_on - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ö–æ–º–∞–Ω–¥–∞ listen_on –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ...");
        
        // 5. –û–ñ–ò–î–ê–ù–ò–ï –°–û–ë–´–¢–ò–Ø NewListenAddr –ù–ê –ù–û–î–ï1
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ NewListenAddr –Ω–∞ –Ω–æ–¥–µ1 (—Ç–∞–π–º–∞—É—Ç 1 —Å–µ–∫—É–Ω–¥–∞)...");
        let listen_event = wait_for_event(
            &mut node1_events,
            |e| matches!(e, NodeEvent::NewListenAddr { .. }),
            Duration::from_secs(1)
        ).await.expect("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è NewListenAddr - —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏—à–ª–æ –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É");
        
        let listen_addr = match listen_event {
            NodeEvent::NewListenAddr { address } => address,
            _ => panic!("‚ùå –ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: {:?}", listen_event),
        };
        
        println!("‚úÖ –ù–æ–¥–∞1 —Å–ª—É—à–∞–µ—Ç –Ω–∞ –∞–¥—Ä–µ—Å–µ: {}", listen_addr);
        
        // 6. –ù–û–î–ê2 –ü–û–î–ö–õ–Æ–ß–ê–ï–¢–°–Ø –ö –ù–û–î–ï1
        println!("üîó –ù–æ–¥–∞2 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–æ–¥–µ1...");
        node2.commander.dial(node1.peer_id().clone(), listen_addr.clone()).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å dial - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ö–æ–º–∞–Ω–¥–∞ dial –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...");
        
        // 7. –û–ñ–ò–î–ê–ù–ò–ï –°–û–ë–´–¢–ò–ô ConnectionEstablished –ù–ê –û–ë–ï–ò–• –ù–û–î–ê–•
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è ConnectionEstablished –Ω–∞ –æ–±–µ–∏—Ö –Ω–æ–¥–∞—Ö (—Ç–∞–π–º–∞—É—Ç 2 —Å–µ–∫—É–Ω–¥—ã)...");
        
        // –û–∂–∏–¥–∞–µ–º ConnectionEstablished –Ω–∞ –Ω–æ–¥–µ2
        let node2_connected = wait_for_event(
            &mut node2_events,
            |e| matches!(e, NodeEvent::ConnectionEstablished { .. }),
            Duration::from_secs(2)
        ).await.expect("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è ConnectionEstablished - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã");
        
        let node2_peer_id = match node2_connected {
            NodeEvent::ConnectionEstablished { peer_id } => peer_id,
            _ => panic!("‚ùå –ù–æ–¥–∞2 –ø–æ–ª—É—á–∏–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: {:?}", node2_connected),
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–¥—ã –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
        assert_eq!(node2_peer_id, *node1.peer_id(), 
            "‚ùå –ù–æ–¥–∞2 –≤–∏–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –ø–∏—Ä–∞: {} –≤–º–µ—Å—Ç–æ {}", 
            node2_peer_id, node1.peer_id());
        
        println!("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:");
        println!("   Node2 ‚Üí Node1: {}", node2_peer_id);
        
        // 8. XSTREAM –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï
        println!("üì° –ù–∞—á–∏–Ω–∞–µ–º XStream –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ...");
        
        // –ù–æ–¥–∞2 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç XStream –∫ –Ω–æ–¥–µ1
        println!("üîÑ –ù–æ–¥–∞2 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç XStream –∫ –Ω–æ–¥–µ1...");
        let mut outbound_xstream = node2.commander.open_xstream(node1.peer_id().clone()).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å XStream - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ XStream –æ—Ç–∫—Ä—ã—Ç —É—Å–ø–µ—à–Ω–æ:");
        println!("   Stream ID: {:?}", outbound_xstream.id);
        println!("   Peer ID: {}", outbound_xstream.peer_id);
        
        // 9. –ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–• –ß–ï–†–ï–ó XSTREAM
        println!("üì§ –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ XStream...");
        
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
        let test_data = b"Hello from Node2 via XStream! This is a real data transfer test.";
        let test_data_wrong = b"Hello from Node2 via XStream! This is a real data transfer tesdsffdt.";
        println!("üìù –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(test_data));
        
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ XStream
        outbound_xstream.write_all(test_data.to_vec()).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ XStream - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ XStream");

        outbound_xstream.write_eof().await;
        
        // 10. –ß–¢–ï–ù–ò–ï –û–¢–í–ï–¢–ê –û–¢ –ù–û–î–´1
        println!("üì• –ù–æ–¥–∞2 —á–∏—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –Ω–æ–¥—ã1...");
        let response_data = match outbound_xstream.read_to_end().await {
            Ok(data) => {
                println!("‚úÖ –ù–æ–¥–∞2 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ –æ—Ç–≤–µ—Ç:");
                println!("   –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: {} –±–∞–π—Ç", data.len());
                println!("   –û—Ç–≤–µ—Ç: {}", String::from_utf8_lossy(&data));
                data
            }
            Err(e) => {
                panic!("‚ùå –ù–æ–¥–∞2 –Ω–µ —Å–º–æ–≥–ª–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç: {:?}", e);
            }
        };
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º XStream –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        println!("üõë –ù–æ–¥–∞2 –∑–∞–∫—Ä—ã–≤–∞–µ—Ç XStream...");
        match outbound_xstream.close().await {
            Ok(_) => println!("‚úÖ –ù–æ–¥–∞2 —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã–ª–∞ XStream"),
            Err(e) => println!("‚ö†Ô∏è  –ù–æ–¥–∞2: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ XStream: {:?}", e),
        }
        
        // 11. –ü–†–û–í–ï–†–ö–ê –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–• –î–ê–ù–ù–´–•
        println!("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...");
        
        // –û–∂–∏–¥–∞–µ–º—ã–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let mut expected_response = test_data.to_vec();
        expected_response.extend_from_slice(b" Real Response");
        
        println!("üìä –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ:");
        println!("   –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {} –±–∞–π—Ç", expected_response.len());
        println!("   –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: {} –±–∞–π—Ç", response_data.len());
        println!("   –û–∂–∏–¥–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(&expected_response));
        println!("   –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(&response_data));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
        assert_eq!(expected_response.len(), response_data.len(), 
            "‚ùå –†–∞–∑–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç: –æ–∂–∏–¥–∞–ª–æ—Å—å {} –±–∞–π—Ç, –ø–æ–ª—É—á–µ–Ω–æ {} –±–∞–π—Ç", 
            expected_response.len(), response_data.len());
        
        assert_eq!(expected_response, response_data.as_slice(), 
            "‚ùå –û—Ç–≤–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º!\n–û–∂–∏–¥–∞–ª–æ—Å—å: {}\n–ü–æ–ª—É—á–µ–Ω–æ: {}", 
            String::from_utf8_lossy(&expected_response), String::from_utf8_lossy(&response_data));
        
        println!("‚úÖ –û—Ç–≤–µ—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç! –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.");
        
        // 12. –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ß–¢–ï–ù–ò–Ø –î–ê–ù–ù–´–• –ù–ê –ù–û–î–ï1
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–æ–¥–µ1 (—Ç–∞–π–º–∞—É—Ç 1 —Å–µ–∫—É–Ω–¥–∞)...");
        
        // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ oneshot –∫–∞–Ω–∞–ª –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        let received_bytes = match timeout(Duration::from_secs(1), data_receiver).await {
            Ok(Ok(data)) => {
                println!("‚úÖ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ oneshot –∫–∞–Ω–∞–ª");
                data
            }
            Ok(Err(_)) => {
                panic!("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ oneshot –∫–∞–Ω–∞–ª");
            }
            Err(_) => {
                panic!("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ oneshot –∫–∞–Ω–∞–ª");
            }
        };
        
        // 13. –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–•
        println!("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
        
        println!("üìä –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:");
        println!("   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {} –±–∞–π—Ç", test_data.len());
        println!("   –ü–æ–ª—É—á–µ–Ω–æ: {} –±–∞–π—Ç", received_bytes.len());
        println!("   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(test_data));
        println!("   –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {}", String::from_utf8_lossy(&received_bytes));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
        assert_eq!(test_data.len(), received_bytes.len(), 
            "‚ùå –†–∞–∑–º–µ—Ä—ã –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {} –±–∞–π—Ç, –ø–æ–ª—É—á–µ–Ω–æ {} –±–∞–π—Ç", 
            test_data.len(), received_bytes.len());
        
        assert_eq!(test_data, received_bytes.as_slice(), 
            "‚ùå –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {}\n–ü–æ–ª—É—á–µ–Ω–æ: {}", 
            String::from_utf8_lossy(test_data), String::from_utf8_lossy(&received_bytes));
        
        println!("‚úÖ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–≤–Ω—ã –ø—Ä–∏–Ω—è—Ç—ã–º.");
        
        // 12. GRACEFUL SHUTDOWN –û–ë–ï–ò–• –ù–û–î
        println!("üõë –í—ã–ø–æ–ª–Ω—è–µ–º graceful shutdown –æ–±–µ–∏—Ö –Ω–æ–¥...");
        node1.commander.shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å graceful shutdown –Ω–æ–¥—ã1 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        node2.commander.shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å graceful shutdown –Ω–æ–¥—ã2 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á...");
        node1.wait_for_shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã1 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        node2.wait_for_shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã2 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        // –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞—á—É –Ω–æ–¥—ã1
        node1_task.abort();
        
        println!("‚úÖ –û–±–µ –Ω–æ–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–∞–±–æ—Ç—É");
        
        // 13. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
        assert_eq!(node1.get_task_status(), "not_started", 
            "‚ùå –ù–æ–¥–∞1 –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'not_started' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        assert_eq!(node2.get_task_status(), "not_started", 
            "‚ùå –ù–æ–¥–∞2 –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'not_started' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        assert!(!node1.is_running(), "‚ùå –ù–æ–¥–∞1 –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ graceful shutdown");
        assert!(!node2.is_running(), "‚ùå –ù–æ–¥–∞2 –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ graceful shutdown");
        
        println!("üéâ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç XStream —Å —Ä–µ–∞–ª—å–Ω—ã–º –æ–±–º–µ–Ω–æ–º –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
        println!("‚úÖ –í—Å–µ —É—Å–ª–æ–≤–∏—è —Ç–µ—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:");
        println!("   - –î–≤–µ –Ω–æ–¥—ã —Å–æ–∑–¥–∞–Ω—ã –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã");
        println!("   - XStream —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç");
        println!("   - –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ XStream");
        println!("   - –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–≤–Ω—ã –ø—Ä–∏–Ω—è—Ç—ã–º");
        println!("   - –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥ —Å–æ–±–ª—é–¥–µ–Ω");
    }).await;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ—Å—Ç —É–ª–æ–∂–∏–ª—Å—è –≤ 5 —Å–µ–∫—É–Ω–¥
    match result {
        Ok(_) => println!("‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ {} —Å–µ–∫—É–Ω–¥ - –í–°–ï–ì–û 5 –°–ï–ö–£–ù–î!", 5),
        Err(_) => panic!("‚ùå –¢–ï–°–¢ –ü–†–ï–í–´–°–ò–õ –õ–ò–ú–ò–¢ –í 5 –°–ï–ö–£–ù–î - –ü–†–û–ë–õ–ï–ú–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò!"),
    }
}

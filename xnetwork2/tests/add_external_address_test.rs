//! –¢–µ—Å—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã add_external_address

use libp2p::Multiaddr;
use xnetwork2::NodeBuilder;

/// –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ commander
#[tokio::test]
async fn test_add_external_address() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç add_external_address...");

    // –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª
    println!("üÜï –°–æ–∑–¥–∞–µ–º node...");
    let mut node = NodeBuilder::new()
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å node —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    // –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª...");
    node.start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å node —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    println!("‚úÖ –£–∑–µ–ª —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω: {:?}", node.peer_id());

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∞–¥—Ä–µ—Å–∞
    println!("üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∞–¥—Ä–µ—Å–∞...");
    
    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å
    let external_addr: Multiaddr = "/ip4/1.2.3.4/tcp/1234".parse()
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å");

    // –î–æ–±–∞–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ commander
    node.commander.add_external_address(external_addr.clone())
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å");

    println!("‚úÖ –í–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω: {}", external_addr);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏
    println!("üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏...");
    let network_state = node.commander.get_network_state()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏");

    println!("üìà –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏:");
    println!("   - Peer ID: {}", network_state.peer_id);
    println!("   - –ê–¥—Ä–µ—Å–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è: {}", network_state.listening_addresses.len());
    println!("   - –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∏—Ä—ã: {}", network_state.connected_peers.len());

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    println!("üßπ –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...");
    node.force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å node —É–∑–µ–ª");

    println!("üéâ –¢–µ—Å—Ç add_external_address —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    Ok(())
}

/// –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤
#[tokio::test]
async fn test_add_multiple_external_addresses() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤...");

    // –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª
    let mut node = NodeBuilder::new()
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å node —É–∑–µ–ª");

    // –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª
    node.start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å node —É–∑–µ–ª");

    println!("‚úÖ –£–∑–µ–ª —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω: {:?}", node.peer_id());

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤
    let addresses: Vec<Multiaddr> = vec![
        "/ip4/1.2.3.4/tcp/1234".parse().unwrap(),
        "/ip4/5.6.7.8/tcp/5678".parse().unwrap(),
        "/dns4/example.com/tcp/443".parse().unwrap(),
    ];

    for addr in &addresses {
        node.commander.add_external_address(addr.clone())
            .await
            .expect(&format!("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å: {}", addr));
        println!("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å: {}", addr);
    }

    println!("‚úÖ –í—Å–µ {} –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã", addresses.len());

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    node.force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å node —É–∑–µ–ª");

    println!("üéâ –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    Ok(())
}

//! –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–æ–¥—ã –∑–∞ 5 —Å–µ–∫—É–Ω–¥

use std::time::Duration;
use tokio::time::timeout;
use xnetwork2::Node;

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –Ω–æ–¥—ã: —Å–æ–∑–¥–∞–Ω–∏–µ ‚Üí –∑–∞–ø—É—Å–∫ ‚Üí –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ ‚Üí —Å–æ–±—ã—Ç–∏–µ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
/// –í–µ—Å—å —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —É–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ 5 —Å–µ–∫—É–Ω–¥
#[tokio::test]
async fn test_node_lifecycle_in_5_seconds() {
    println!("üß™ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–æ–¥—ã (5 —Å–µ–∫—É–Ω–¥)...");
    
    // –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤–µ—Å—å —Ç–µ—Å—Ç - 5 —Å–µ–∫—É–Ω–¥
    let result = timeout(Duration::from_secs(5), async {
        // 1. –°–û–ó–î–ê–ù–ò–ï –ù–û–î–´ (0-1 —Å–µ–∫—É–Ω–¥–∞)
        println!("üÜï –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É...");
        let mut node = Node::new().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ù–æ–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å PeerId: {}", node.peer_id());
        
        // 2. –ü–û–î–ü–ò–°–ö–ê –ù–ê –°–û–ë–´–¢–ò–Ø –î–û –ó–ê–ü–£–°–ö–ê
        println!("üì° –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–æ–¥—ã...");
        let mut events = node.subscribe();
        
        // 3. –ó–ê–ü–£–°–ö –ù–û–î–´ (1-2 —Å–µ–∫—É–Ω–¥—ã)
        println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–¥—É...");
        node.start().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ù–æ–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á–∏: {}", node.get_task_status());
        
        // 4. –ö–û–ú–ê–ù–î–ê LISTEN_ON (2-3 —Å–µ–∫—É–Ω–¥—ã)
        println!("üéØ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É listen_on...");
        node.commander.listen_on("/ip4/127.0.0.1/udp/0/quic-v1".parse().unwrap()).await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å listen_on - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ö–æ–º–∞–Ω–¥–∞ listen_on –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ...");
        
        // 5. –û–ñ–ò–î–ê–ù–ò–ï –°–û–ë–´–¢–ò–Ø NewListenAddr (3-4 —Å–µ–∫—É–Ω–¥—ã)
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ NewListenAddr (—Ç–∞–π–º–∞—É—Ç 2 —Å–µ–∫—É–Ω–¥—ã)...");
        let listen_event = timeout(Duration::from_secs(2), async {
            loop {
                match events.recv().await {
                    Ok(event) => {
                        println!("üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: {:?}", event);
                        if let xnetwork2::node_events::NodeEvent::NewListenAddr { address } = event {
                            return address;
                        }
                    }
                    Err(e) => panic!("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: {} - —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", e),
                }
            }
        }).await.expect("‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è NewListenAddr - —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏—à–ª–æ –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã");
        
        println!("‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ NewListenAddr: {}", listen_event);
        
        // 6. –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò (4-4.5 —Å–µ–∫—É–Ω–¥—ã)
        println!("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö...");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥—Ä–µ—Å –Ω–µ –ø—É—Å—Ç–æ–π
        assert!(!listen_event.to_string().is_empty(), 
            "‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –∞–¥—Ä–µ—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–∞
        assert!(listen_event.to_string().contains("/ip4/127.0.0.1/udp/"),
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–∞: {} - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", listen_event);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥—Ä–µ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Ä—Ç (—Å–∏—Å—Ç–µ–º–∞ –Ω–∞–∑–Ω–∞—á–∏–ª–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç)
        assert!(listen_event.to_string().contains("/udp/"),
            "‚ùå –ê–¥—Ä–µ—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Ä—Ç: {} - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–∏–ª–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç", listen_event);
        
        println!("‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!");
        
        // 7. GRACEFUL SHUTDOWN (4.5-5 —Å–µ–∫—É–Ω–¥)
        println!("üõë –í—ã–ø–æ–ª–Ω—è–µ–º graceful shutdown...");
        node.commander.shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å graceful shutdown - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏...");
        node.wait_for_shutdown().await
            .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
        
        println!("‚úÖ –ù–æ–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É");
        
        // 8. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
        assert_eq!(node.get_task_status(), "not_started", 
            "‚ùå –ù–æ–¥–∞ –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'not_started' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        assert!(!node.is_running(), 
            "‚ùå –ù–æ–¥–∞ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ graceful shutdown");
        
        println!("üéâ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    }).await;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ—Å—Ç —É–ª–æ–∂–∏–ª—Å—è –≤ 5 —Å–µ–∫—É–Ω–¥
    match result {
        Ok(_) => println!("‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ {} —Å–µ–∫—É–Ω–¥ - –í–°–ï–ì–û 5 –°–ï–ö–£–ù–î!", 5),
        Err(_) => panic!("‚ùå –¢–ï–°–¢ –ü–†–ï–í–´–°–ò–õ –õ–ò–ú–ò–¢ –í 5 –°–ï–ö–£–ù–î - –ü–†–û–ë–õ–ï–ú–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò!"),
    }
}

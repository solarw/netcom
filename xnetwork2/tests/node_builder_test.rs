//! –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ NodeBuilder –∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

use xnetwork2::{InboundDecisionPolicy, Node};

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ Node —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
#[tokio::test]
async fn test_node_builder_with_different_configurations() {
    println!("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º NodeBuilder —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏...");

    // –¢–µ—Å—Ç 1: Node —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (ManualApprove)
    println!("üÜï –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...");
    let mut node_default = Node::builder()
        .await
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");

    println!("‚úÖ –ù–æ–¥–∞ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    println!("   PeerId: {}", node_default.peer_id());

    // –¢–µ—Å—Ç 2: Node —Å —è–≤–Ω–æ–π ManualApprove –ø–æ–ª–∏—Ç–∏–∫–æ–π
    println!("üÜï –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —Å —è–≤–Ω–æ–π ManualApprove –ø–æ–ª–∏—Ç–∏–∫–æ–π...");
    let mut node_manual = Node::builder()
        .await
        .with_inbound_decision_policy(InboundDecisionPolicy::ManualApprove)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É —Å ManualApprove –ø–æ–ª–∏—Ç–∏–∫–æ–π");

    println!("‚úÖ –ù–æ–¥–∞ —Å ManualApprove –ø–æ–ª–∏—Ç–∏–∫–æ–π —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    println!("   PeerId: {}", node_manual.peer_id());

    // –¢–µ—Å—Ç 3: Node —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π
    println!("üÜï –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π...");
    let mut node_custom = Node::builder()
        .await
        .with_event_buffer_size(64)
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞");

    println!("‚úÖ –ù–æ–¥–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    println!("   PeerId: {}", node_custom.peer_id());

    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–¥—ã
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –Ω–æ–¥—ã...");
    node_default
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
    node_manual
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É —Å ManualApprove");
    node_custom
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º");

    println!("‚úÖ –í—Å–µ –Ω–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã:");
    println!("   Default: {}", node_default.get_task_status());
    println!("   ManualApprove: {}", node_manual.get_task_status());
    println!("   CustomBuffer: {}", node_custom.get_task_status());

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–¥—ã
    println!("üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–æ–¥—ã...");
    node_default
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
    node_manual
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É —Å ManualApprove");
    node_custom
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º");

    node_default
        .wait_for_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
    node_manual
        .wait_for_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã —Å ManualApprove");
    node_custom
        .wait_for_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º");

    println!("‚úÖ –í—Å–µ –Ω–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
    println!("üéâ –¢–µ—Å—Ç NodeBuilder –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
}

/// –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Node::new()
#[tokio::test]
async fn test_backward_compatibility() {
    println!("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Node::new()...");

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    let mut node_old = Node::new()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ Node::new()");

    println!("‚úÖ –ù–æ–¥–∞ —á–µ—Ä–µ–∑ Node::new() —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    println!("   PeerId: {}", node_old.peer_id());

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —á–µ—Ä–µ–∑ NodeBuilder —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let mut node_new = Node::builder()
        .await
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ NodeBuilder");

    println!("‚úÖ –ù–æ–¥–∞ —á–µ—Ä–µ–∑ NodeBuilder —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    println!("   PeerId: {}", node_new.peer_id());

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–µ –Ω–æ–¥—ã
    node_old
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ Node::new()");
    node_new
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ NodeBuilder");

    println!("‚úÖ –û–±–µ –Ω–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã:");
    println!("   Node::new(): {}", node_old.get_task_status());
    println!("   NodeBuilder: {}", node_new.get_task_status());

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–¥—ã
    node_old
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ Node::new()");
    node_new
        .commander
        .shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É —á–µ—Ä–µ–∑ NodeBuilder");

    node_old
        .wait_for_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã —á–µ—Ä–µ–∑ Node::new()");
    node_new
        .wait_for_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–¥—ã —á–µ—Ä–µ–∑ NodeBuilder");

    println!("‚úÖ –û–±–µ –Ω–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
    println!("üéâ –¢–µ—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
}

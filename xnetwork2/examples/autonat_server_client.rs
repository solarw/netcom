//! –ü—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è AutoNAT –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º—ã
//!
//! –≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å:
//! - –°–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª —Å AutoNAT –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è NAT
//! - –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª —Å AutoNAT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ NAT

use std::time::Duration;
use tokio::time::sleep;
use xnetwork2::NodeBuilder;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–º–µ—Ä —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è AutoNAT –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º—ã...");

    // –§–ê–ó–ê 1: –°–æ–∑–¥–∞–Ω–∏–µ —É–∑–ª–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ AutoNAT
    println!("üõ†Ô∏è –§–∞–∑–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ —É–∑–ª–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ AutoNAT...");

    println!("üÜï –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª —Å AutoNAT Server...");
    let mut server_node = NodeBuilder::new()
        .with_autonat_server()  // –í–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π AutoNAT
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    println!("üÜï –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª —Å AutoNAT Client...");
    let mut client_node = NodeBuilder::new()
        .with_autonat_client()  // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π AutoNAT
        .build()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    // –ó–∞–ø—É—Å–∫ —É–∑–ª–æ–≤
    println!("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —É–∑–ª—ã...");
    server_node
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
    client_node
        .start()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");

    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ swarm loops
    sleep(Duration::from_millis(100)).await;
    println!("‚úÖ –£–∑–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã:");
    println!("   - –°–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª: {:?}", server_node.peer_id());
    println!("   - –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª: {:?}", client_node.peer_id());

    // –§–ê–ó–ê 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
    println!("üéØ –§–∞–∑–∞ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è...");

    println!("üéØ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è...");
    let server_addr = server_node.commander.listen_on("/ip4/0.0.0.0/udp/0/quic-v1".parse()?)
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —É–∑–ª–µ");
    println!("üì° –°–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª —Å–ª—É—à–∞–µ—Ç –Ω–∞: {}", server_addr);

    println!("üéØ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è...");
    let client_addr = client_node.commander.listen_on("/ip4/0.0.0.0/udp/0/quic-v1".parse()?)
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —É–∑–ª–µ");
    println!("üì° –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª —Å–ª—É—à–∞–µ—Ç –Ω–∞: {}", client_addr);

    // –§–ê–ó–ê 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ AutoNAT
    println!("üîç –§–∞–∑–∞ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ AutoNAT...");

    // –î–∞–µ–º –≤—Ä–µ–º—è AutoNAT –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    sleep(Duration::from_secs(2)).await;

    match server_node.get_xroutes_status().await {
        Ok(status) => {
            println!("üìà XRoutes —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É–∑–ª–∞:");
            println!("   - AutoNAT Server: {}", status.autonat_server_enabled);
            println!("   - AutoNAT Client: {}", status.autonat_client_enabled);
            println!("   - AutoNAT (legacy): {}", status.autonat_enabled);
            assert!(status.autonat_server_enabled, "‚ùå AutoNAT Server –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —É–∑–ª–µ");
            assert!(!status.autonat_client_enabled, "‚ùå AutoNAT Client –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∫–ª—é—á–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —É–∑–ª–µ");
        }
        Err(e) => panic!("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å XRoutes —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É–∑–ª–∞: {}", e),
    }

    match client_node.get_xroutes_status().await {
        Ok(status) => {
            println!("üìà XRoutes —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —É–∑–ª–∞:");
            println!("   - AutoNAT Server: {}", status.autonat_server_enabled);
            println!("   - AutoNAT Client: {}", status.autonat_client_enabled);
            println!("   - AutoNAT (legacy): {}", status.autonat_enabled);
            assert!(!status.autonat_server_enabled, "‚ùå AutoNAT Server –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∫–ª—é—á–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —É–∑–ª–µ");
            assert!(status.autonat_client_enabled, "‚ùå AutoNAT Client –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —É–∑–ª–µ");
        }
        Err(e) => panic!("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å XRoutes –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —É–∑–ª–∞: {}", e),
    }

    // –§–ê–ó–ê 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏
    println!("üìä –§–∞–∑–∞ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏...");

    match server_node.commander.get_network_state().await {
        Ok(state) => {
            println!("üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É–∑–ª–∞:");
            println!("   - PeerId: {}", state.peer_id);
            println!("   - –ê–¥—Ä–µ—Å–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è: {}", state.listening_addresses.len());
            println!("   - –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∏—Ä—ã: {}", state.connected_peers.len());
            
            for addr in state.listening_addresses {
                println!("   - –°–ª—É—à–∞–µ—Ç –Ω–∞: {}", addr);
            }
        }
        Err(e) => panic!("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É–∑–ª–∞: {}", e),
    }

    match client_node.commander.get_network_state().await {
        Ok(state) => {
            println!("üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —É–∑–ª–∞:");
            println!("   - PeerId: {}", state.peer_id);
            println!("   - –ê–¥—Ä–µ—Å–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è: {}", state.listening_addresses.len());
            println!("   - –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∏—Ä—ã: {}", state.connected_peers.len());
            
            for addr in state.listening_addresses {
                println!("   - –°–ª—É—à–∞–µ—Ç –Ω–∞: {}", addr);
            }
        }
        Err(e) => panic!("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —É–∑–ª–∞: {}", e),
    }

    // –§–ê–ó–ê 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞
    println!("üèÅ –§–∞–∑–∞ 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞...");

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
    println!("üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤...");
    server_node
        .force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª");
    client_node
        .force_shutdown()
        .await
        .expect("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª");

    println!("üéâ –ü—Ä–∏–º–µ—Ä —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è AutoNAT —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
    println!("   - –°–µ—Ä–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª: {:?} (AutoNAT Server)", server_node.peer_id());
    println!("   - –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É–∑–µ–ª: {:?} (AutoNAT Client)", client_node.peer_id());
    println!("   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ AutoNAT –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");

    Ok(())
}

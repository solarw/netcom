# XAuth Design Documentation

## Обзор

XAuth - это протокол децентрализованной аутентификации для NetCom, обеспечивающий безопасную верификацию узлов и сущностей в P2P сети. Основная концепция - Proof of Representation (PoR), позволяющая узлам подтверждать свою принадлежность к сущности (NetID).

## Архитектура

### Основные компоненты

#### 1. Proof of Representation (PoR)
```rust
pub struct ProofOfRepresentation {
    pub owner_public_key: PublicKey,  // NetID владельца
    pub peer_id: PeerId,              // Идентификатор узла
    pub issued_at: u64,               // Время создания (UNIX timestamp)
    pub expires_at: u64,              // Время истечения
    pub signature: Vec<u8>,           // Цифровая подпись владельца
}
```

#### 2. XAuth Behaviour
- Интегрируется в libp2p NetworkBehaviour
- Обрабатывает аутентификационные запросы и ответы
- Управляет состоянием аутентификации соединений

#### 3. Connection Data
- Хранит состояние аутентификации для каждого соединения
- Отслеживает процесс верификации PoR
- Управляет временем жизни аутентификации

## Процесс аутентификации

### 1. Инициализация соединения
```
Клиент (Alice)              Сервер (Bob)
     | --- Connection Established ---> |
     | <--- Auth Challenge ----------- |
     | --- PoR + Signature ----------> |
     | <--- Auth Result -------------- |
```

### 2. Подробный процесс

#### Шаг 1: Challenge
Сервер отправляет challenge для предотвращения replay-атак:
```rust
struct AuthChallenge {
    nonce: [u8; 32],        // Случайное значение
    timestamp: u64,         // Временная метка
    server_netid: NetID,    // NetID сервера
}
```

#### Шаг 2: Proof of Representation
Клиент отправляет PoR с подписью:
```rust
struct AuthResponse {
    por: ProofOfRepresentation,
    challenge_signature: Vec<u8>,  // Подпись challenge
    client_netid: NetID,
}
```

#### Шаг 3: Верификация
Сервер проверяет:
1. Валидность подписи PoR
2. Соответствие NetID в PoR
3. Валидность подписи challenge
4. Срок действия PoR

## Реализация

### Структура модулей

```
protocols/xauth/
├── src/
│   ├── lib.rs              # Основной модуль
│   ├── behaviours.rs       # NetworkBehaviour
│   ├── por.rs             # Proof of Representation
│   ├── connection_data.rs  # Состояние соединений
│   ├── events.rs          # События аутентификации
│   └── definitions.rs     # Типы данных
└── tests/
    └── behaviour_tests.rs  # Интеграционные тесты
```

### Key Features

#### 1. Безопасность
- **Цифровые подписи** на основе Ed25519
- **Nonce-based challenges** для предотвращения replay-атак
- **Временные ограничения** для PoR
- **Верификация цепочки доверия**

#### 2. Производительность
- **Асинхронная обработка** запросов
- **Кэширование результатов** аутентификации
- **Минимальные накладные расходы** на сеть

#### 3. Гибкость
- **Поддержка различных алгоритмов** подписи
- **Настраиваемые политики** аутентификации
- **Расширяемая архитектура** для будущих улучшений

## Интеграция с NetID

### Связь с Entity-Node Architecture

XAuth обеспечивает криптографическую связь между:
- **NetID** (публичный ключ сущности)
- **PeerId** (идентификатор узла)
- **Proof of Representation** (доказательство принадлежности)

### Пример использования

```rust
// Создание PoR для узла
let por = ProofOfRepresentation::create(
    &owner_keypair,     // Приватный ключ владельца
    node_peer_id,       // PeerId узла
    Duration::from_days(30)  // Срок действия
)?;

// Верификация PoR при подключении
match por.validate() {
    Ok(()) => {
        // Аутентификация успешна
        connection.authenticate(por.owner_public_key);
    }
    Err(e) => {
        // Ошибка аутентификации
        connection.reject_auth(e);
    }
}
```

## Безопасность

### Угрозы и защита

#### 1. MITM-атаки
- **Защита**: Цифровые подписи и challenge-response
- **Механизм**: Верификация подписей и временных меток

#### 2. Replay-атаки
- **Защита**: Nonce-based challenges
- **Механизм**: Уникальные значения для каждого запроса

#### 3. Подделка PoR
- **Защита**: Криптографическая верификация
- **Механизм**: Проверка подписей и сроков действия

### Best Practices

1. **Регулярное обновление PoR** - ограниченный срок действия
2. **Использование надежных ключей** - Ed25519 или аналоги
3. **Валидация всех полей** - полная проверка данных
4. **Логирование событий** - для аудита и отладки

## Будущие улучшения

### Планируемые функции

1. **Поддержка цепочек доверия** - делегирование аутентификации
2. **Анонимная аутентификация** - zero-knowledge proofs
3. **Квантово-устойчивые алгоритмы** - подготовка к будущему
4. **Интеграция с Web3** - совместимость с блокчейн-идентификаторами

### Совместимость

XAuth спроектирован для легкой интеграции с:
- Существующими системами аутентификации
- Стандартами WebAuthn
- Блокчейн-идентификаторами
- Корпоративными системами безопасности

## Заключение

XAuth предоставляет надежную основу для децентрализованной аутентификации в NetCom, обеспечивая безопасное подтверждение принадлежности узлов к сущностям через механизм Proof of Representation. Архитектура спроектирована для масштабирования, безопасности и простоты интеграции с существующими системами.

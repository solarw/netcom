# XAuth - Документация для разработчиков

## Обзор проекта

**XAuth** - это Rust библиотека для взаимной аутентификации в P2P сетях на основе Proof of Representation (PoR). Проект предоставляет механизм безопасной аутентификации между узлами с использованием цифровых подписей и временных меток.

### Основная функциональность:
- **Proof of Representation (PoR)** - структура для делегирования полномочий
- **Взаимная аутентификация** - двусторонняя проверка подлинности узлов
- **Управление соединениями** - отслеживание состояния аутентификации
- **Обработка таймаутов** - автоматическое завершение долгих операций
- **Метаданные** - передача дополнительной информации при аутентификации

## Архитектура

### Ключевые модули:

#### `behaviours.rs`
- Основная логика аутентификации
- Реализация `NetworkBehaviour` для интеграции с libp2p
- Обработка входящих и исходящих запросов аутентификации
- Управление таймаутами и состояниями соединений

#### `por.rs` (Proof of Representation)
- Создание и валидация PoR структур
- Сериализация/десериализация публичных ключей
- Проверка подписей и временных меток
- Утилиты для работы с ключами

#### `definitions.rs`
- Определения типов данных и констант
- Состояния аутентификации (`DirectionalAuthState`, `CombinedAuthState`)
- Протокольные сообщения (`PorAuthRequest`, `PorAuthResponse`)

#### `events.rs`
- События аутентификации для уведомления приложения
- Успешная/неудачная аутентификация, таймауты, запросы верификации

#### `connection_data.rs`
- Управление данными соединений
- Отслеживание состояния аутентификации для каждого соединения

## Быстрая интеграция

### Добавление в проект:
```toml
[dependencies]
xauth = { path = "../xauth" }
```

### Базовое использование:
```rust
use xauth::{
    behaviours::PorAuthBehaviour,
    por::por::{PorUtils, ProofOfRepresentation},
};
use libp2p::{identity::Keypair, PeerId};
use std::time::Duration;

// Создание ключей и PoR
let owner_keypair = PorUtils::generate_owner_keypair();
let node_keypair = Keypair::generate_ed25519();
let node_peer_id = PeerId::from(node_keypair.public());

let por = ProofOfRepresentation::create(
    &owner_keypair,
    node_peer_id,
    Duration::from_secs(3600) // 1 час
).expect("Failed to create POR");

// Создание поведения аутентификации
let auth_behaviour = PorAuthBehaviour::new(por);

// Интеграция в libp2p Swarm
```

### Обработка событий:
```rust
match event {
    PorAuthEvent::MutualAuthSuccess { peer_id, connection_id, address, metadata } => {
        // Полная взаимная аутентификация успешна
    }
    PorAuthEvent::VerifyPorRequest { peer_id, connection_id, address, por, metadata } => {
        // Запрос на верификацию PoR от удаленного узла
        // Принять решение и вызвать submit_por_verification_result
    }
    PorAuthEvent::AuthTimeout { peer_id, connection_id, address, direction } => {
        // Таймаут аутентификации
    }
}
```

## Текущее состояние

### Качество кода:
- **Покрытие тестами**: 77.27% (306/396 строк)
- **Количество тестов**: 16 успешных unit-тестов
- **Стабильность**: Протестированы основные сценарии
- **Готовность**: Готов для интеграции в проекты

### Статистика покрытия:
- `behaviours.rs`: 69.76% (основная логика)
- `connection_data.rs`: 91.18% (отличное покрытие)
- `por.rs`: 88.75% (хорошее покрытие)

### Непокрытые области:
- Сложные сценарии обработки ошибок
- Edge cases сериализации
- Некоторые Swarm события

## Дорожная карта

### Приоритет 1 (ближайшие задачи):
1. **Увеличение покрытия тестами до 90%+**
   - Тесты обработки ошибок в `behaviours.rs`
   - Тесты сложных Swarm сценариев
   - Тесты edge cases сериализации

2. **Создание пользовательской документации**
   - README с примерами использования
   - API документация
   - Руководство по интеграции

### Приоритет 2 (среднесрочные цели):
1. **Интеграционные тесты**
   - Тесты реальной работы в swarm
   - Тесты производительности
   - Тесты совместимости

2. **Улучшение обработки ошибок**
   - Более информативные ошибки
   - Retry механизмы
   - Улучшенное логирование

### Приоритет 3 (долгосрочные планы):
1. **Расширение функциональности**
   - Поддержка multiple PoR
   - Динамические таймауты
   - Альтернативные форматы сериализации

2. **Оптимизация производительности**
   - Бенчмарки
   - Оптимизация памяти
   - Параллельная обработка

## Технические детали

### Протокол:
- **Идентификатор**: `/por-auth/1.0.0`
- **Формат**: CBOR сериализация
- **Таймаут аутентификации**: 10 секунд
- **Таймаут верификации**: 30 секунд

### Зависимости:
- `libp2p` 0.56 (локальная версия)
- `serde` 1.0 с поддержкой derive
- `tokio` для асинхронных тестов

### Совместимость:
- Rust 2024 edition
- Интегрируется с любым libp2p swarm
- Поддерживает все основные транспорты libp2p

---

*Этот документ предназначен для помощи AI-ассистентам в быстром понимании проекта xauth и его текущего состояния.*

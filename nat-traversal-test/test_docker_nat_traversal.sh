#!/bin/bash

# –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è NAT traversal —á–µ—Ä–µ–∑ docker-compose
# –ê–Ω–∞–ª–æ–≥ test_relay_connection.sh, –Ω–æ –¥–ª—è docker-compose

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ NAT traversal —Ç–µ—Å—Ç–∞ –≤ docker-compose..."
echo "=================================================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å —Ç–µ—Å—Ç–æ–º
cd "$(dirname "$0")"

# –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f .env ]; then
    echo "üîë –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env —Ñ–∞–π–ª..."
    ../nat-traversal-bin/target/release/generate_env
fi

echo "‚úÖ .env —Ñ–∞–π–ª –≥–æ—Ç–æ–≤"

# –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ docker-compose
echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º docker-compose..."
docker compose up -d

echo "‚úÖ Docker-compose –∑–∞–ø—É—â–µ–Ω"

# –®–∞–≥ 3: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
echo "‚è≥ –û–∂–∏–¥–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (30 —Å–µ–∫—É–Ω–¥)..."
sleep 30

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."

# –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
LOGS=$(docker compose logs --no-color 2>&1)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
SUCCESS=true

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º node1..."
if echo "$LOGS" | grep -q "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–∏—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ relay"; then
    echo "‚úÖ node1 —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ node2 —á–µ—Ä–µ–∑ relay"
else
    echo "‚ùå node1 –ù–ï –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ node2 —á–µ—Ä–µ–∑ relay"
    SUCCESS=false
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º node2..."
if echo "$LOGS" | grep -q "‚úÖ Node –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"; then
    echo "‚úÖ node2 —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
else
    echo "‚ùå node2 –ù–ï –∑–∞–ø—É—â–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    SUCCESS=false
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º relay..."
if echo "$LOGS" | grep -q "‚úÖ Relay —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"; then
    echo "‚úÖ relay —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå relay –ù–ï –∑–∞–ø—É—â–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    SUCCESS=false
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Kademlia DHT..."
if echo "$LOGS" | grep -q "‚úÖ Kademlia DHT –≤–∫–ª—é—á–µ–Ω–∞"; then
    echo "‚úÖ Kademlia DHT —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö"
else
    echo "‚ùå Kademlia DHT –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"
    SUCCESS=false
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
if echo "$LOGS" | grep -q "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ relay —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"; then
    echo "‚úÖ –£–∑–ª—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ relay"
else
    echo "‚ùå –£–∑–ª—ã –ù–ï –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ relay"
    SUCCESS=false
fi

# –®–∞–≥ 5: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
echo "üßπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º docker-compose..."
docker compose down

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo ""
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"

if [ "$SUCCESS" = true ]; then
    echo "üéâ NAT traversal —É—Å–ø–µ—à–µ–Ω!"
    echo "   - node1 –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ node2 —á–µ—Ä–µ–∑ relay"
    echo "   - node2 –ø–æ–ª—É—á–∏–ª –≤—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" 
    echo "   - relay –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
    exit 0
else
    echo "‚ùå NAT traversal –Ω–µ —É–¥–∞–ª—Å—è"
    echo ""
    echo "üìã –õ–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:"
    echo "$LOGS" | tail -50
    exit 1
fi

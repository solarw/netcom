#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
set -e

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NAT traversal —á–µ—Ä–µ–∑ relay (3 —É–∑–ª–∞)..."
echo "========================================================================"

# -----------------------
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ env vars
# -----------------------
run_with_prefix() {
    local prefix="$1"
    shift
    # env –ø–µ—Ä–µ–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã) —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã
    # sed -u (unbuffered) –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –≤—ã–≤–æ–¥ –ø–æ—è–≤–ª—è–ª—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
    
    # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ sed –≤ stderr (>&2).
    env "$@" 2>&1 | sed -u "s/^/[$prefix] /" >&2 &
    
    echo $!  # PID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –∫–æ–Ω–≤–µ–π–µ—Ä–µ (sed)
}

# -----------------------
# –§–ê–ó–ê 0: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# -----------------------
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
cargo build
echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
if [ ! -f "./target/debug/relay" ] || [ ! -f "./target/debug/node" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ ./target/debug/"
    exit 1
fi
echo "‚úÖ –ë–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã 'relay' –∏ 'node' –Ω–∞–π–¥–µ–Ω—ã –≤ ./target/debug/"

# -----------------------
# –§–ê–ó–ê 0.1: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π
# -----------------------
if [ -f .env ]; then
    source .env
    echo "üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ .env"
else
    echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ generate_env –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π."
    exit 1
fi

echo "üîë –ö–ª—é—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ .env:"
echo "   - Relay Peer ID: $RELAY_PEER_ID"
echo "   - Node1 Peer ID: $NODE1_PEER_ID"
echo "   - Node2 Peer ID: $NODE2_PEER_ID"

# -----------------------
# –§–ê–ó–ê 1: –ó–∞–ø—É—Å–∫ relay —Å–µ—Ä–≤–µ—Ä–∞
# -----------------------
echo ""
echo "üöÄ –§–ê–ó–ê 1: –ó–∞–ø—É—Å–∫ relay —Å–µ—Ä–≤–µ—Ä–∞..."
# –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ —á–µ—Ä–µ–∑ 'cargo run'
RELAY_PID=$(run_with_prefix "RELAY" NODE_KEY="$RELAY_KEY" ./target/debug/relay)

echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ relay —Å–µ—Ä–≤–µ—Ä–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PID (sed) –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ï—Å–ª–∏ relay —É–ø–∞–¥–µ—Ç, sed —Ç–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
if ps -p $RELAY_PID > /dev/null; then
    echo "‚úÖ Relay —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $RELAY_PID)"
else
    echo "‚ùå Relay —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

# -----------------------
# –§–ê–óA 2: –ó–∞–ø—É—Å–∫ node2 (–ø–∞—Å—Å–∏–≤–Ω—ã–π —É–∑–µ–ª)
# -----------------------
echo ""
echo "üîÑ –§–ê–ó–ê 2: –ó–∞–ø—É—Å–∫ node2 (–ø–∞—Å—Å–∏–≤–Ω—ã–π —É–∑–µ–ª)..."
# –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏ —É–±–∏—Ä–∞–µ–º '--'
NODE2_PID=$(run_with_prefix "NODE2" NODE_KEY="$NODE2_KEY" ./target/debug/node \
    --relay-address 127.0.0.1:15003 --relay-peer-id "$RELAY_PEER_ID")

echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ node2 (3 —Å–µ–∫—É–Ω–¥—ã)..."
sleep 3

if ps -p $NODE2_PID > /dev/null; then
    echo "‚úÖ Node2 –∑–∞–ø—É—â–µ–Ω (PID: $NODE2_PID)"
else
    echo "‚ùå Node2 –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    # –û—á–∏—Å—Ç–∫–∞ relay
    pkill -KILL -f "target/debug/relay" 2>/dev/null || true
    exit 1
fi

# -----------------------
# –§–ê–ó–ê 3: –ó–∞–ø—É—Å–∫ node1 (–∞–∫—Ç–∏–≤–Ω—ã–π —É–∑–µ–ª) –∏ –æ–∂–∏–¥–∞–Ω–∏–µ
# -----------------------
echo ""
echo "üéØ –§–ê–ó–ê 3: –ó–∞–ø—É—Å–∫ node1 (–∞–∫—Ç–∏–≤–Ω—ã–π —É–∑–µ–ª)..."
echo "üì° Node1 –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Node2 —á–µ—Ä–µ–∑ relay..."

# –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏ —É–±–∏—Ä–∞–µ–º '--'
NODE1_PID=$(run_with_prefix "NODE1" NODE_KEY="$NODE1_KEY" ./target/debug/node \
    --relay-address 127.0.0.1:15003 --relay-peer-id "$RELAY_PEER_ID" --target-peer "$NODE2_PEER_ID")

# –î–∞–µ–º 1 —Å–µ–∫—É–Ω–¥—É –Ω–∞ –∑–∞–ø—É—Å–∫, —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
sleep 1

if ! ps -p $NODE1_PID > /dev/null; then
    echo "‚ùå Node1 –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ."
    NODE1_STATUS="STOPPED"
else
    echo "‚è≥ Node1 –∑–∞–ø—É—â–µ–Ω (PID: $NODE1_PID). –ñ–¥–µ–º 20 —Å–µ–∫—É–Ω–¥, –ø—Ä–æ–≤–µ—Ä—è—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å..."
    sleep 45 # –û–±—â–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è = 1 + 19 = 20 —Å–µ–∫—É–Ω–¥
    
    if ps -p $NODE1_PID > /dev/null; then
        echo "‚úÖ Node1 –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç."
        NODE1_STATUS="RUNNING"
    else
        echo "‚ùå Node1 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, —Å –æ—à–∏–±–∫–æ–π) –≤ —Ç–µ—á–µ–Ω–∏–µ 20 —Å–µ–∫—É–Ω–¥."
        NODE1_STATUS="STOPPED"
    fi
fi


# -----------------------
# –§–ê–ó–ê 4: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
# -----------------------
echo ""
echo "üìä –§–ê–ó–ê 4: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ NAT traversal..."

if [ "$NODE1_STATUS" = "RUNNING" ]; then
    echo "üéâ –£–°–ü–ï–•: Node1 –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, (–≤–µ—Ä–æ—è—Ç–Ω–æ) –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."
    echo "   - NAT traversal —á–µ—Ä–µ–∑ relay —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
    RESULT=0
else
    echo "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: Node1 –Ω–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏–ª–∏ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è."
    RESULT=1
fi

# -----------------------
# –§–ê–ó–ê 5: –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
# -----------------------
echo ""
echo "üßπ –§–ê–ó–ê 5: –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤..."

# –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å –º—ã –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã, –∞ –Ω–µ 'cargo run'
echo "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã 'target/debug/node'..."
pkill -KILL -f "target/debug/node" 2>/dev/null || true

echo "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã 'target/debug/relay'..."
pkill -KILL -f "target/debug/relay" 2>/dev/null || true

# –î–∞–µ–º 0.5—Å, —á—Ç–æ–±—ã –û–° –∑–∞–≤–µ—Ä—à–∏–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã
sleep 0.5

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
echo ""
echo "üèÅ –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø NAT TRAVERSAL:"
if [ $RESULT -eq 0 ]; then
    echo "üéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: NAT traversal —á–µ—Ä–µ–∑ relay —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
    echo "   - Relay: $RELAY_PEER_ID"
    echo "   - Node1: $NODE1_PEER_ID"
    echo "   - Node2: $NODE2_PEER_ID"
else
    echo "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏ –∏ relay"
fi

exit $RESULT
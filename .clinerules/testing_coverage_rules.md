# Правила тестирования и отчетов о покрытии

## Терминология и метрики

### Code Coverage (Покрытие кода)
- **Определение**: Процент строк кода, выполняемых во время тестов
- **Измерение**: Инструментами cargo-tarpaulin, grcov, lcov
- **Формат**: [процент]% ([покрытые строки]/[всего строк])
- **Цель**: Оценить, какая часть кода проверяется тестами

### Test Success Rate (Успешность тестов)  
- **Определение**: Процент тестов, которые проходят успешно
- **Измерение**: Результаты выполнения `cargo nextest run`
- **Формат**: [процент]% ([успешные тесты]/[всего тестов])
- **Цель**: Оценить стабильность тестовой базы

### Различие метрик
- **Покрытие кода ≠ Успешность тестов**
- Высокое покрытие + низкая успешность = проблемы в коде
- Низкое покрытие + высокая успешность = недостаток тестов
- Идеал: высокое покрытие + высокая успешность

## Общие принципы

### 1. Стандарты тестового покрытия по приоритетам
- **PRIORITY 1: CORE**: 95%+ покрытие (критический функционал)
- **PRIORITY 2: CORE_CONNECTIONS**: 90%+ покрытие (высокий приоритет)
- **PRIORITY 3: XAUTH**: 85%+ покрытие (высокий приоритет, безопасность)
- **PRIORITY 4: XSTREAM**: 80%+ покрытие (средний приоритет)
- **PRIORITY 5: DISCOVERY**: 75%+ покрытие (средний приоритет)
- **PRIORITY 6: CONNECTIVITY**: 70%+ покрытие (низкий приоритет)

### 2. Инкрементальная валидация покрытия
- Проверять покрытие только после успешного прохождения всех тестов группы
- Останавливать проверку покрытия при проблемах в группах более высокого приоритета
- Использовать команды приоритетного тестирования (см. xnetwork_func_prio.md)

### 2. Форматы отчетов

#### Центральный отчет (docs/coverage.md)
```
# Отчет о тестовом покрытии NetCom

## coverage report: [дата время]

## Code Coverage Report (Покрытие кода)
- **Общее покрытие**: [процент]% ([покрытые строки]/[всего строк])
- **Покрытие по компонентам**: [детали]

## Test Success Report (Успешность тестов)
- **Общая успешность**: [процент]% ([успешные тесты]/[всего тестов])
- **Успешность по компонентам**: [детали]

### Компонент 1
- **Покрытие кода**: [процент]% ([покрытые]/[всего] строк)
- **Успешность тестов**: [процент]% ([успешные]/[всего] тестов)
- **Оценка**: [GOOD/FAIR/POOR]
- **Статус**: [краткое описание]

### Компонент 2
- **Покрытие кода**: [процент]% ([покрытые]/[всего] строк)
- **Успешность тестов**: [процент]% ([успешные]/[всего] тестов)
- **Оценка**: [GOOD/FAIR/POOR]
- **Статус**: [краткое описание]

## Общая оценка проекта
- **Среднее покрытие кода**: [процент]%
- **Общая успешность тестов**: [процент]%
- **Статус**: [GOOD/FAIR/POOR]
- **Готовность**: [описание готовности]
```

#### Детальные отчеты (protocols/[компонент]/coverage.md)
```
# Детальный отчет о тестовом покрытии [Компонент]

## Общая статистика
- **Покрытие кода**: [процент]% ([покрытые]/[всего] строк)
- **Успешность тестов**: [процент]% ([успешные]/[всего] тестов)
- **Непокрытые строки**: [число]
- **Статус**: [GOOD/FAIR/POOR]

## Детали по файлам
[детали по каждому файлу]

## Проблемные области
[список проблемных областей]

## Минимальный план улучшения
[план улучшения по приоритетам]

## Рекомендации
[рекомендации по тестированию]
```

### 3. Критерии оценки покрытия

#### GOOD (75-100%)
- Основной функционал полностью покрыт тестами
- Edge cases обработаны
- Интеграционные тесты присутствуют
- Готов для продакшен-использования

#### FAIR (50-74%)
- Основной функционал частично покрыт
- Некоторые edge cases не протестированы
- Требуется дополнительное тестирование
- Готов для разработки и прототипирования

#### POOR (0-49%)
- Критический функционал не протестирован
- Высокий риск багов в продакшене
- Требуется срочное улучшение тестового покрытия
- Не готов для продакшен-использования

## Процесс тестирования

### 1. Запуск тестового покрытия
```bash
# Для конкретного компонента
cd protocols/[компонент] && cargo tarpaulin --out Lcov

# Для всего проекта
find protocols -name "Cargo.toml" -execdir cargo tarpaulin --out Lcov \;
```

### 2. Обновление отчетов
- Центральный отчет обновляется после каждого анализа
- Детальные отчеты обновляются при изменении покрытия >5%
- Временные метки включаются для отслеживания прогресса

### 3. Инструменты и команды

#### Основные команды
```bash
# Запуск тестов с nextest (рекомендуется)
cargo nextest run

# Запуск тестового покрытия
cargo tarpaulin --out Lcov

# Просмотр отчета покрытия
cargo tarpaulin --out Html && open tarpaulin-report.html
```

#### Интеграционные тесты
```bash
# Запуск интеграционных тестов
cargo nextest run --test integration_tests

# Запуск сетевых тестов
cargo nextest run --test network_tests

# Запуск тестов по паттерну имени
cargo nextest run core
cargo nextest run xauth
cargo nextest run xstream
```

## Критерии качества тестов

### 1. Unit-тесты
- Тестируют отдельные функции и методы
- Используют реальные компоненты (без заглушек)
- Покрывают все ветки кода
- Включают edge cases и граничные условия

### 2. Интеграционные тесты
- Тестируют взаимодействие компонентов
- Используют реальную сетевую коммуникацию
- Включают сценарии сбоев и восстановления
- Проверяют производительность

### 3. Критерии успешного тестирования
- Все тесты проходят
- Покрытие соответствует стандартам
- Интеграционные тесты работают с реальной сетью
- Edge cases обработаны корректно

## Поддержание качества

### 1. Периодические проверки
- Еженедельный запуск полного тестового набора
- Обновление отчетов покрытия после значительных изменений
- Регулярный ревью тестового покрытия

### 2. Автоматизация
- CI/CD пайплайн включает проверку покрытия
- Автоматическое обновление отчетов
- Уведомления о падении покрытия

### 3. Документация
- Все тесты документированы
- Отчеты покрытия доступны и актуальны
- Планы улучшения четко определены

## Рекомендации по реализации

### 1. Приоритеты тестирования
1. **Критический функционал** - аутентификация, передача данных
2. **Edge cases** - сетевые сбои, таймауты, частичные данные
3. **Интеграционные сценарии** - взаимодействие компонентов
4. **Производительность** - нагрузочное тестирование

### 2. Инструменты
- **cargo-tarpaulin** - для анализа покрытия
- **tokio-test** - для асинхронного тестирования
- **libp2p-swarm-test** - для сетевого тестирования

### 4. Условия измерения покрытия кода
- **Измерять покрытие кода ТОЛЬКО когда все тесты проходят успешно**
- Если есть падающие тесты - сначала исправить их, затем измерять покрытие
- Покрытие кода при падающих тестах считается недействительным
- Приоритет: успешность тестов > покрытие кода

### 5. Оптимизация процесса тестирования
- **Запускать тесты с флагом `--fail-fast` для остановки после первого падения**
- **Использовать `cargo test -- --fail-fast` для немедленного реагирования на ошибки**
- **Приоритет: быстрое обнаружение и исправление ошибок > полный прогон всех тестов**
- **Измерять покрытие кода только после успешного прохождения всех тестов**

### 6. Рекомендуемые команды для разработки:
```bash
# Быстрое тестирование с остановкой при первой ошибке
cargo nextest run --fail-fast

# Для конкретного модуля тестов
cargo nextest run core

# Полный прогон (только для CI/CD или финальной проверки)
cargo nextest run

# Измерение покрытия кода (только после успешных тестов)
cargo tarpaulin --out Lcov
```

### 7. Best practices
- Писать тесты параллельно с кодом
- Использовать реальные компоненты вместо заглушек
- Тестировать все возможные сценарии ошибок
- Поддерживать актуальность отчетов покрытия

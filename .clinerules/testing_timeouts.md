# Требования к таймаутам тестов NetCom

Этот файл определяет стандарты и требования к ограничениям времени выполнения тестов для предотвращения зависаний и блокирования процесса разработки.

## Общие принципы

### 1. Запрет бесконечных ожиданий
- **Все тесты должны иметь разумные ограничения по времени выполнения**
- **Запрещены бесконечные циклы ожидания** в тестовой оснастке
- **Максимальное время выполнения одного теста: 30 секунд**

### 2. Стандарты таймаутов по типам операций

#### Базовые операции (5-10 секунд)
- Создание ноды: 5 секунд
- Запуск прослушивания: 5 секунд
- Завершение работы ноды: 5 секунд
- Получение сетевого состояния: 5 секунд

#### Сетевые операции (10-15 секунд)
- Установление соединения между нодами: 10 секунд
- Отключение соединения: 10 секунд
- Ожидание сетевых событий: 10 секунд
- Аутентификация (xauth): 15 секунд

#### Интеграционные операции (20-30 секунд)
- Работа с потоками данных (xstream): 20 секунд
- Механизмы обнаружения (discovery): 25 секунд
- Сложные сетевые сценарии: 30 секунд

#### Длительные тесты (специальные)
- Тесты стабильности: должны быть явно помечены и иметь отдельные конфигурации
- Нагрузочные тесты: отдельная категория с собственными таймаутами

## Требования к реализации

### 1. Использование tokio::time::timeout
```rust
// ПРАВИЛЬНО
tokio::time::timeout(Duration::from_secs(10), async {
    // асинхронная операция
}).await.expect("Operation timed out");

// НЕПРАВИЛЬНО
loop {
    if condition_met {
        break;
    }
    tokio::time::sleep(Duration::from_millis(100)).await;
}
```

### 2. Тестовая оснастка
- Все методы ожидания в `test_utils.rs` должны принимать параметр `timeout: Duration`
- Методы должны возвращать `Result` или `Option` для обработки таймаутов
- По умолчанию использовать стандартные таймауты из этого документа

### 3. Обработка ошибок таймаутов
```rust
match tokio::time::timeout(timeout, operation).await {
    Ok(result) => result,
    Err(_) => {
        // Явное сообщение о том, какая операция зависла
        panic!("Operation '{}' timed out after {:?}", operation_name, timeout);
    }
}
```

## Примеры реализации

### Тестовая оснастка
```rust
impl NodeExt for TestNode {
    async fn wait_for_event<F>(
        &mut self, 
        predicate: F, 
        timeout: Duration
    ) -> Option<NetworkEvent>
    where
        F: Fn(&NetworkEvent) -> bool,
    {
        tokio::time::timeout(timeout, async {
            while let Some(event) = self.events.recv().await {
                if predicate(&event) {
                    return Some(event);
                }
            }
            None
        }).await.ok().flatten()
    }
}
```

### Тесты
```rust
#[tokio::test]
async fn test_node_startup_with_timeout() {
    let mut node = TestNode::new().await.expect("Failed to create node");
    
    // Использование таймаута
    let listen_addr = tokio::time::timeout(
        Duration::from_secs(10),
        node.listen_with_test_config()
    ).await.expect("Node startup timed out")
     .expect("Failed to start listening");
    
    assert!(!listen_addr.to_string().is_empty());
}
```

## Конфигурация nextest

### nextest.toml
```toml
[profile.default]
# Ограничение времени выполнения тестов
test-timeout = "30s"
# Остановка при первом падении
fail-fast = true

[profile.ci]
test-timeout = "60s"
```

### Запуск тестов с таймаутами
```bash
# Стандартный запуск
cargo nextest run

# Запуск с увеличенными таймаутами (только для CI)
cargo nextest run --profile ci

# Запуск конкретного теста с отладкой
cargo nextest run test_node_startup --no-capture
```

## Мониторинг и отладка

### Логирование таймаутов
- При таймауте тест должен явно указывать, какая операция зависла
- Включить логирование для отладки зависаний
- Использовать `--no-capture` для просмотра логов во время выполнения

### Рекомендации по отладке
1. **Проверить сетевые условия** - тесты могут зависать из-за сетевых проблем
2. **Увеличить таймауты локально** для отладки конкретных проблем
3. **Использовать `tokio::time::sleep` с осторожностью** - только для искусственных задержек

## Исключения

### Длительные тесты
Тесты, требующие более 30 секунд, должны быть:
1. Явно помечены в названии (например, `test_long_running_stability`)
2. Иметь отдельную конфигурацию в `nextest.toml`
3. Запускаться только в CI или по явному запросу

### Интеграционные тесты
Сложные интеграционные тесты могут требовать увеличенных таймаутов, но должны быть оптимизированы для минимизации времени выполнения.

## Обновление существующих тестов

Все существующие тесты должны быть обновлены в соответствии с этими требованиями:
1. Добавить таймауты во все методы ожидания
2. Убедиться, что тесты завершаются в разумные сроки
3. Обработать случаи, когда события не происходят в ожидаемое время

## Ответственность разработчиков

Каждый разработчик обязан:
- Следовать этим стандартам при написании новых тестов
- Обновлять существующие тесты при их модификации
- Сообщать о случаях зависания тестов для дальнейшей оптимизации
